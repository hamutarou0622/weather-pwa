<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>æš‡ã¤ã¶ã—ã‚µã‚¤ãƒˆ + ä»Šæ—¥ã®å¤©æ°—</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* ============ æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ« ============ */
    body { font-family: 'Helvetica Neue', Arial, sans-serif; margin:0; padding:0; background-color:#1a1a1a; color:#f5f5f5; overflow-x:hidden; scroll-behavior:smooth; }
    .background { position:fixed; top:0; left:0; width:100%; height:100%; z-index:-2; background-size:cover; background-position:center; transition:opacity 1s ease-in-out; opacity:0; }
    .background.active { opacity:1; }
    header { background-color:#111; color:white; padding:1.5em 0; text-align:center; letter-spacing:1px; border-bottom:2px solid #444; box-shadow:0 4px 8px rgba(0,0,0,.5); position:relative; }
    header h1 { margin:0; font-weight:300; font-size:3em; letter-spacing:.1em; animation:fadeIn 2s ease-in-out; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
    .section-container { margin:40px auto; max-width:1200px; padding:20px; background-color:rgba(255,255,255,.1); border-radius:10px; box-shadow:0 8px 16px rgba(0,0,0,.2); opacity:0; transform:translateY(50px); transition:opacity .6s ease-out, transform .6s ease-out; }
    .visible { opacity:1; transform:translateY(0); }
    .hidden-button { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:transparent; border:none; width:200px; height:100px; cursor:pointer; outline:none; transition:background-color .5s ease; z-index:10; }
    .hidden-button:hover { background-color:yellow; }
    .flame-bg { position:relative; width:100%; height:500px; background:url('https://i.gifer.com/OzG.gif') no-repeat center/cover; overflow:hidden; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,.3); animation:scaleIn 2s ease-in-out; }
    .goal-text { position:absolute; top:50%; left:100%; font-family:'Impact', sans-serif; font-size:200px; font-weight:bold; color:#ff0000; transform:translateY(-50%); white-space:nowrap; animation:slideGoal 5s cubic-bezier(.42,0,.58,1) infinite; text-shadow:4px 4px 8px rgba(0,0,0,.7); }
    @keyframes scaleIn { from{transform:scale(.9); opacity:.5;} to{transform:scale(1); opacity:1;} }
    @keyframes slideGoal { 0%{ left:100%; transform:translateY(-50%) scale(.8);} 20%{ left:50%; transform:translateY(-50%) scale(1.1);} 40%{ left:0%; transform:translateY(-50%) scale(1);} 60%{ left:-50%; transform:translateY(-50%) scale(1.1);} 100%{ left:-100%; transform:translateY(-50%) scale(.8);} }
    .tasks-playlist { display:flex; justify-content:space-between; gap:20px; margin-top:20px; }
    .todo-list, .playlist { width:48%; padding:20px; border-radius:8px; background-color:#2a2a2a; box-shadow:0 4px 8px rgba(0,0,0,.3); animation:fadeInUp 1s ease-in-out; }
    @keyframes fadeInUp { from{ opacity:0; transform:translateY(20px);} to{ opacity:1; transform:translateY(0);} }
    .todo-list h2, .playlist h2 { font-size:1.8em; margin-bottom:20px; color:#f5f5f5; font-weight:500; border-bottom:2px solid #444; padding-bottom:10px; }
    #todo-items, #playlist-items { list-style:none; padding:0; margin:0; }
    #todo-items li, #playlist-items li { padding:12px; margin-bottom:10px; background-color:#333; border-radius:6px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,.2); transition:box-shadow .3s ease, transform .3s ease; }
    #todo-items li:hover, #playlist-items li:hover { box-shadow:0 4px 8px rgba(0,0,0,.3); transform:translateY(-3px); }
    #todo-items li button, #playlist-items li button { background-color:#ff4d4d; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; transition:background-color .2s ease; }
    #todo-items li button:hover, #playlist-items li button:hover { background-color:#ff1a1a; }
    input[type="text"], input[type="file"], input[type="password"] { width:100%; padding:12px; border-radius:4px; border:1px solid #444; margin-bottom:10px; box-sizing:border-box; background-color:#2a2a2a; color:#f5f5f5; transition:border-color .3s ease; }
    input[type="text"]:focus, input[type="file"]:focus, input[type="password"]:focus { border-color:#007bff; outline:none; }
    button { background-color:#007bff; color:white; padding:10px 20px; border:none; border-radius:4px; cursor:pointer; font-size:16px; transition:background-color .3s ease, transform .3s ease; }
    button:hover { background-color:#0056b3; transform:translateY(-3px); }
    .soccer-scoreboard iframe, .league-widget iframe { width:100%; height:500px; border-radius:8px; border:none; box-shadow:0 4px 8px rgba(0,0,0,.2); transition:transform .3s ease; }
    .soccer-scoreboard iframe:hover, .league-widget iframe:hover { transform:scale(1.02); }
    .audio-player { display:flex; flex-direction:column; align-items:center; background-color:#2a2a2a; padding:20px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,.3); animation:fadeInUp 1s ease-in-out; }
    .audio-player audio { width:100%; margin-top:20px; border-radius:8px; background-color:#444; }
    footer { text-align:center; padding:2em 0; background-color:#111; color:white; font-size:14px; border-top:2px solid #444; box-shadow:0 -4px 8px rgba(0,0,0,.5); animation:fadeIn 2s ease-in-out; }
    #protected-content { display:none; }
    /* ğŸ’©: 15ç§’ä¸Šé™ï¼ˆ1å›ã®ã¿ï¼‰ */
    .poop-emoji { font-size:50px; position:fixed; top:-50px; z-index:9999; animation: fall var(--dur, 5s) linear 1; text-shadow:0 0 10px rgba(255,255,0,.75); }
    @keyframes fall { to{ transform:translateY(100vh) rotate(360deg);} }
    .poop-emoji::before { content:'ğŸ’©'; color:#ff0000; animation:poopGlow 2s linear infinite alternate; }
    @keyframes poopGlow { 0%{ text-shadow:0 0 10px rgba(255,0,0,.5);} 100%{ text-shadow:0 0 20px rgba(255,255,0,1);} }
    .calendar-container { display:flex; justify-content:space-between; align-items:flex-start; gap:20px; }
    #calendar-header { display:flex; justify-content:space-between; align-items:center; }
    #calendar-header button { background-color:#007bff; color:white; padding:10px 20px; border:none; border-radius:4px; cursor:pointer; font-size:16px; transition:background-color .3s ease, transform .3s ease; }
    #calendar-header button:hover { background-color:#0056b3; transform:translateY(-3px); }
    #calendar { flex:1; }
    table.calendar { width:100%; background-color:#444; border-collapse:collapse; border-radius:8px; overflow:hidden; }
    table.calendar th, table.calendar td { padding:10px; text-align:center; border:1px solid #666; color:#f5f5f5; cursor:pointer; }
    table.calendar th { background-color:#333; }
    table.calendar td:hover { background-color:#555; }
    .selected-date { background-color:#007bff; }
    .memo-display { background-color:#2a2a2a; color:#f5f5f5; padding:20px; border-radius:8px; margin-top:20px; display:none; }
    #calendar-memo { width:300px; padding:20px; background-color:#2a2a2a; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,.3); }
    #calendar-memo textarea { width:100%; height:200px; padding:10px; border-radius:4px; background-color:#333; color:#f5f5f5; border:1px solid #444; resize:none; }
    #calendar-memo button { margin-top:10px; }

    /* ============ è¿½åŠ ï¼šå¤©æ°—ã‚«ãƒ¼ãƒ‰ & PWAæ“ä½œ ============ */
    .topbar-actions { position:absolute; top:12px; right:12px; display:flex; gap:8px; }
    .pwa-ghost { background:#222; color:#fff; border-radius:10px; padding:8px 12px; font-size:12px; border:1px solid #333; }
    .weather-card { display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center; background:#222; border:1px solid #333; border-radius:12px; padding:14px; }
    .weather-main { display:flex; gap:16px; align-items:flex-end; }
    .weather-big { font-size:34px; line-height:1; }
    .muted { color:#aaa; }
    .two-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .tiny { font-size:12px; }
    @media (max-width: 768px){ .tasks-playlist { flex-direction:column; } #calendar-memo{ width:100%; } .goal-text{ font-size:120px; } }
  </style>
</head>
<body>
  <!-- èƒŒæ™¯ -->
  <div id="particle-background" class="background active" style="background-image:url('https://i.gifer.com/9viJ.gif');"></div>
  <div id="sky-background" class="background" style="background-image:url('https://i.gifer.com/bF4.gif');"></div>
  <div id="earth-background" class="background" style="background-image:url('https://i.gifer.com/NSu6.gif');"></div>

  <header>
    <h1>æš‡ã¤ã¶ã—ã‚µã‚¤ãƒˆ</h1>
    <!-- éš ã—ãƒœã‚¿ãƒ³ï¼ˆé˜¿éƒ¨å¯›ï¼‰ -->
    <button class="hidden-button" onclick="redirectToAbePage()"></button>
    <!-- PWA æ“ä½œç”¨ -->
    <div class="topbar-actions">
      <button id="installBtn" class="pwa-ghost" style="display:none">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
      <button id="notifyBtn" class="pwa-ghost">é€šçŸ¥</button>
    </div>
  </header>

  <!-- â˜… è¿½åŠ ï¼šä»Šæ—¥ã®å¤©æ°—ï¼ˆ+æ˜æ—¥ï¼‰ -->
  <section class="section-container" id="weather-section">
    <h2><i class="fa-solid fa-cloud-sun"></i> ä»Šæ—¥ã¨æ˜æ—¥ã®å¤©æ°—</h2>
    <div class="weather-card">
      <div class="weather-main">
        <div>
          <div class="tiny muted">åœ°ç‚¹</div>
          <div id="placeLabel">â€”</div>
          <div class="tiny muted" id="updatedLabel">æ›´æ–°: â€”</div>
        </div>
        <div>
          <div id="todayTemp" class="weather-big">--â„ƒ</div>
          <div id="todayRange" class="muted">ä»Šæ—¥: æœ€é«˜ --â„ƒ / æœ€ä½ --â„ƒ</div>
          <div id="todayPop" class="muted">é™æ°´ç¢ºç‡ --%</div>
          <div style="height:8px"></div>
          <div id="tomorrowRange" class="muted">æ˜æ—¥: æœ€é«˜ --â„ƒ / æœ€ä½ --â„ƒ</div>
          <div id="tomorrowPop" class="muted">é™æ°´ç¢ºç‡ --%</div>
        </div>
      </div>
      <div class="two-grid">
        <button id="useGeo">ç¾åœ¨åœ°ã‹ã‚‰å–å¾—</button>
        <button id="openSettings">åœ°ç‚¹ã‚’è¨­å®š</button>
      </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«é¢¨ã‚«ãƒ¼ãƒ‰ -->
    <div class="section-container" id="settings" style="display:none; padding:16px;">
      <div class="tiny muted">éƒ½å¸‚åï¼ˆä¾‹: Kiyosu, Aichi, JPï¼‰</div>
      <input type="text" id="cityInput" placeholder="éƒ½å¸‚åï¼ˆè‹±èªæ¨å¥¨ï¼‰" />
      <div class="tiny muted" style="margin-top:8px;">* æ­£ç¢ºã«å‡ºã—ãŸã„å ´åˆã¯ç·¯åº¦çµŒåº¦ã‚’ä½¿ã„ã¾ã™ï¼ˆä¾‹: 35.1815, 136.9066ï¼‰ã€‚</div>
      <div class="tiny muted" style="margin-top:8px;">ç·¯åº¦, çµŒåº¦ï¼ˆä»»æ„ï¼‰</div>
      <input type="text" id="latlonInput" placeholder="35.1815, 136.9066" />
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="saveCity">ä¿å­˜ã—ã¦æ›´æ–°</button>
        <button id="closeSettings">é–‰ã˜ã‚‹</button>
      </div>
      <div class="tiny muted" style="margin-top:8px;">â€» åˆå›ã¯ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚æ‹’å¦ã—ãŸå ´åˆã¯ã€Œåœ°ç‚¹ã‚’è¨­å®šã€ã‹ã‚‰éƒ½å¸‚åã§å–å¾—ã§ãã¾ã™ã€‚</div>
    </div>
  </section>

  <!-- æ—¢å­˜ï¼šGOOOAL ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <section class="flame-bg section-container" id="goal-animation-section">
    <div class="goal-text">GOOOAL</div>
  </section>

  <!-- æ—¢å­˜ï¼šç›®æ¬¡ã¨ToDoãƒªã‚¹ãƒˆ -->
  <section class="tasks-playlist section-container" id="todo-list-section">
    <div class="todo-list">
      <h2><i class="fas fa-tasks"></i> To Do List</h2>
      <ul id="todo-items"></ul>
      <input type="text" id="todo-input" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ " />
      <button onclick="addTodo()">è¿½åŠ </button>
    </div>
    <div class="playlist">
      <h2><i class="fas fa-list"></i> ç›®æ¬¡</h2>
      <ul id="playlist-items">
        <li><a href="#goal-animation-section">GOOOAL ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</a></li>
        <li><a href="#todo-list-section">To Do ãƒªã‚¹ãƒˆ</a></li>
        <li><a href="#soccer-scoreboard-section">æˆ¦è¡“ãƒœãƒ¼ãƒ‰</a></li>
        <li><a href="#laliga-widget-section">ãƒ©ãƒ»ãƒªãƒ¼ã‚¬</a></li>
        <li><a href="#premierleague-widget-section">ãƒ—ãƒ¬ãƒŸã‚¢ãƒªãƒ¼ã‚°</a></li>
        <li><a href="#calendar-section">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a></li>
        <li><a href="#password-protected-section">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·</a></li>
        <li><a href="#audio-player-section">éŸ³æ¥½ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼</a></li>
        <li><a href="#minitokyo-3d-section">MiniTokyo 3D</a></li>
      </ul>
    </div>
  </section>

  <!-- æ—¢å­˜ï¼šMiniTokyo 3D -->
  <section class="section-container" id="minitokyo-3d-section">
    <h2>MiniTokyo 3D</h2>
    <iframe src="https://minitokyo3d.com/" width="100%" height="600" style="border:none;"></iframe>
  </section>

  <!-- æ—¢å­˜ï¼šãƒªãƒ¼ã‚°æƒ…å ±ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ -->
  <section class="league-widget section-container" id="laliga-widget-section">
    <h2>ãƒ©ãƒ»ãƒªãƒ¼ã‚¬</h2>
    <iframe src="https://www.bing.com/sportsdetails?q=%E3%83%A9%E3%80%80%E3%83%AA%E3%83%BC%E3%81%8C&sport=Soccer&scenario=League&TimezoneId=Tokyo%20Standard%20Time&league=Soccer_SpainLaLiga&intent=Generic&seasonyear=2024&segment=sports&isl2=true&" frameborder="0" scrolling="yes"></iframe>
  </section>
  <section class="league-widget section-container" id="premierleague-widget-section">
    <h2>ãƒ—ãƒ¬ãƒŸã‚¢ãƒªãƒ¼ã‚°</h2>
    <iframe src="https://www.bing.com/sportsdetails?q=%E3%83%97%E3%83%AC%E3%83%9F%E3%82%A2%E3%83%AA%E3%83%BC%E3%82%B0&sport=Soccer&scenario=League&TimezoneId=Tokyo%20Standard%20Time&league=Soccer_EnglandPremierLeague&intent=Generic&seasonyear=2024&segment=sports&isl2=true&" frameborder="0" scrolling="yes"></iframe>
  </section>

  <!-- æ—¢å­˜ï¼šæˆ¦è¡“ãƒœãƒ¼ãƒ‰ -->
  <section class="soccer-scoreboard section-container" id="soccer-scoreboard-section">
    <h2>æˆ¦è¡“ãƒœãƒ¼ãƒ‰</h2>
    <iframe src="https://www.footballbox.club/tactics-board.html"></iframe>
  </section>

  <!-- æ—¢å­˜ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ãƒ¡ãƒ¢ -->
  <section class="section-container calendar-container" id="calendar-section">
    <div id="calendar-header">
      <button onclick="changeMonth(-1)">å‰æœˆ</button>
      <h2 id="current-month"><i class="fas fa-calendar-alt"></i> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
      <button onclick="changeMonth(1)">æ¬¡æœˆ</button>
    </div>
    <div id="calendar"></div>
    <div id="calendar-memo">
      <h2>ã“ã®æ—¥ã®ãƒ¡ãƒ¢</h2>
      <textarea id="memo-textarea" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
      <button onclick="saveMemo()">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
    </div>
  </section>
  <div id="memo-display" class="memo-display">
    <h2>ãƒ¡ãƒ¢:</h2>
    <p id="memo-content"></p>
  </div>

  <!-- æ—¢å­˜ï¼šéŸ³æ¥½ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ï¼ˆä¿®æ­£æ¸ˆï¼‰ -->
  <section class="section-container audio-player" id="audio-player-section">
    <h2>éŸ³æ¥½ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼</h2>
    <audio id="audio-player" controls></audio>
    <input type="file" id="audio-upload" accept="audio/*" multiple style="display:none" />
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button onclick="addMusic()">éŸ³æ¥½ã‚’è¿½åŠ </button>
      <button onclick="playRandom()">ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ</button>
    </div>
    <ul id="playlist"></ul>
  </section>

  <!-- æ—¢å­˜ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ï¼ˆãƒªãƒ³ã‚¯å‰Šé™¤æ¸ˆã¿ï¼‰ -->
  <section class="password-protected section-container" id="password-protected-section">
    <h2>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·</h2>
    <input type="password" id="password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
    <button onclick="checkPassword()">ç¢ºèª</button>
    <div id="protected-content">
      <p>ã“ã“ã«ç§˜å¯†ã®å†…å®¹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
    </div>
  </section>

  <footer>
    <p>&copy; 2024 æš‡ã¤ã¶ã—ã‚µã‚¤ãƒˆ</p>
  </footer>

  <script>
    // ========= å…±é€šDOMå‚ç…§ =========
    let audioFiles = [];
    let audioPlayer = document.getElementById('audio-player');
    const calendar = document.getElementById('calendar');
    const memoTextarea = document.getElementById('memo-textarea');
    const memoDisplay = document.getElementById('memo-display');
    const memoContent = document.getElementById('memo-content');
    const currentMonthDisplay = document.getElementById('current-month');
    let selectedDate = null; let currentYear = new Date().getFullYear(); let currentMonth = new Date().getMonth();

    // ========= ToDo =========
    function addTodo(){ const todoInput=document.getElementById('todo-input'); const todoItems=document.getElementById('todo-items'); const task=todoInput.value.trim(); if(!task){ alert('ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return;} const li=document.createElement('li'); li.textContent=task; const del=document.createElement('button'); del.textContent='å‰Šé™¤'; del.onclick=()=>todoItems.removeChild(li); li.appendChild(del); todoItems.appendChild(li); todoInput.value=''; }

    // ========= éŸ³æ¥½ï¼ˆä¿®æ­£ï¼šãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ï¼†å†ç”Ÿãƒªã‚¹ãƒˆæ§‹ç¯‰ï¼‰ =========
    function addMusic(){ document.getElementById('audio-upload').click(); }
    document.getElementById('audio-upload').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files).filter(f=>f.type.startsWith('audio/'));
      if(!files.length){ alert('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
      const list = document.getElementById('playlist');
      files.forEach((f)=>{
        audioFiles.push(f);
        const li = document.createElement('li');
        const title = document.createElement('span');
        title.textContent = f.name + ' ';
        const btn = document.createElement('button');
        btn.textContent = 'å†ç”Ÿ';
        btn.onclick = ()=>{
          try{ if(audioPlayer.src) URL.revokeObjectURL(audioPlayer.src); }catch{}
          audioPlayer.src = URL.createObjectURL(f);
          audioPlayer.play();
        };
        li.appendChild(title); li.appendChild(btn); list.appendChild(li);
      });
      // 1æ›²ç›®ã‚’è‡ªå‹•å†ç”Ÿ
      if(files[0]){
        try{ if(audioPlayer.src) URL.revokeObjectURL(audioPlayer.src); }catch{}
        audioPlayer.src = URL.createObjectURL(files[0]);
        audioPlayer.play();
      }
      e.target.value=''; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ãƒªã‚»ãƒƒãƒˆ
    });

    function playRandom(){ if(audioFiles.length===0){ alert('éŸ³æ¥½ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return;} const i=Math.floor(Math.random()*audioFiles.length); const f=audioFiles[i]; try{ if(audioPlayer.src) URL.revokeObjectURL(audioPlayer.src); }catch{} audioPlayer.src=URL.createObjectURL(f); audioPlayer.play(); }

    // ========= ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ15ç§’ä¸Šé™ï¼‰ =========
    function checkPassword(){ const pw=document.getElementById('password-input').value; const correct='poop'; if(pw===correct){ triggerPoopAnimation(); document.getElementById('protected-content').style.display='block'; } else { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚'); } }
    function triggerPoopAnimation(){
      const COUNT = 30;
      for(let i=0;i<COUNT;i++){
        let d=document.createElement('div');
        d.textContent='ğŸ’©';
        d.classList.add('poop-emoji');
        d.style.left=Math.random()*100+'vw';
        const dur = (Math.random()*10+5).toFixed(2)+'s'; // 5ã€œ15ç§’
        d.style.setProperty('--dur', dur);
        document.body.appendChild(d);
        d.addEventListener('animationend',()=>d.remove());
      }
      // å¿µã®ãŸã‚15ç§’å¾Œã«æ®‹éª¸ã‚’å…¨æƒé™¤
      setTimeout(()=>{ document.querySelectorAll('.poop-emoji').forEach(x=>x.remove()); }, 15000);
    }

    // ========= ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¡¨ç¤º =========
    function handleScroll(){ const sections=document.querySelectorAll('.section-container'); sections.forEach(s=>{ const r=s.getBoundingClientRect(); if(r.top<window.innerHeight-100){ s.classList.add('visible'); } }); }
    document.addEventListener('scroll', handleScroll);

    // ========= èƒŒæ™¯åˆ‡æ›¿ =========
    function cycleBackgrounds(){ const p=document.getElementById('particle-background'); const s=document.getElementById('sky-background'); const e=document.getElementById('earth-background'); let cur='particle'; setInterval(()=>{ if(cur==='particle'){ p.classList.remove('active'); s.classList.add('active'); e.classList.remove('active'); cur='sky'; } else if(cur==='sky'){ p.classList.remove('active'); s.classList.remove('active'); e.classList.add('active'); cur='earth'; } else { p.classList.add('active'); s.classList.remove('active'); e.classList.remove('active'); cur='particle'; } }, 20000); }
    function redirectToAbePage(){ alert('éš ã—ãƒœã‚¿ãƒ³ã‚’ç™ºè¦‹ï¼é˜¿éƒ¨å¯›ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...'); window.location.href='https://abehiroshi.la.coocan.jp/'; }

    // ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ =========
    function createCalendar(year, month){ calendar.innerHTML=''; const daysInMonth=new Date(year, month+1, 0).getDate(); const firstDay=new Date(year, month, 1).getDay(); const table=document.createElement('table'); table.classList.add('calendar'); const thead=document.createElement('thead'); const tbody=document.createElement('tbody'); const headerRow=document.createElement('tr'); ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(d=>{ const th=document.createElement('th'); th.textContent=d; headerRow.appendChild(th); }); thead.appendChild(headerRow); table.appendChild(thead); let row=document.createElement('tr'); for(let i=0;i<firstDay;i++){ row.appendChild(document.createElement('td')); }
      for(let day=1; day<=daysInMonth; day++){ if(row.children.length===7){ tbody.appendChild(row); row=document.createElement('tr'); } const cell=document.createElement('td'); cell.textContent=day; cell.onclick=function(ev){ selectDate(year, month+1, day, ev); }; row.appendChild(cell); }
      tbody.appendChild(row); table.appendChild(tbody); calendar.appendChild(table); updateMonthDisplay(); }
    function updateMonthDisplay(){ const names=["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"]; currentMonthDisplay.textContent=`${names[currentMonth]} ${currentYear}`; }
    function changeMonth(step){ currentMonth+=step; if(currentMonth<0){ currentMonth=11; currentYear--; } else if(currentMonth>11){ currentMonth=0; currentYear++; } createCalendar(currentYear, currentMonth); }
    function selectDate(year, month, day, ev){ selectedDate=`${year}-${month}-${day}`; document.querySelectorAll('td').forEach(td=>td.classList.remove('selected-date')); ev.target.classList.add('selected-date'); loadMemo(selectedDate); }
    function saveMemo(){ if(!selectedDate){ alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } const memoText=memoTextarea.value; if(memoText){ localStorage.setItem(`memo-${selectedDate}`, memoText); alert('ãƒ¡ãƒ¢ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼'); loadMemo(selectedDate); } else { alert('ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); } }
    function loadMemo(date){ const saved=localStorage.getItem(`memo-${date}`); if(saved){ memoContent.textContent=saved; memoDisplay.style.display='block'; } else { memoDisplay.style.display='none'; } }

    // ========= å¤©æ°—ï¼ˆOpenâ€‘Meteoï¼šä»Šæ—¥ + æ˜æ—¥ï¼‰ =========
    const $q = (s)=>document.querySelector(s);
    const store = { get k(){ return 'pwa.weather.settings.v1'; }, load(){ try{ return JSON.parse(localStorage.getItem(this.k)||'{}'); }catch{ return {}; } }, save(v){ localStorage.setItem(this.k, JSON.stringify(v||{})); } };
    function fmtDate(d){ const z=n=>String(n).padStart(2,'0'); return `${d.getMonth()+1}/${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`; }
    async function geocodeCity(name){ const u=new URL('https://geocoding-api.open-meteo.com/v1/search'); u.search=new URLSearchParams({ name, count:1, language:'ja', format:'json' }); const r=await fetch(u); if(!r.ok) throw new Error('geocode fail'); const j=await r.json(); if(!j.results?.length) throw new Error('no results'); const { latitude, longitude, name:n, country }=j.results[0]; return { lat: latitude, lon: longitude, label: country?`${n}, ${country}`: n }; }
    async function fetchWeather(lat, lon){ const u=new URL('https://api.open-meteo.com/v1/forecast'); u.search=new URLSearchParams({ latitude:lat, longitude:lon, daily:'temperature_2m_max,temperature_2m_min,precipitation_probability_max', timezone:'Asia/Tokyo' }); const r=await fetch(u, { cache:'no-store' }); if(!r.ok) throw new Error('wx fail'); return await r.json(); }
    function renderWeather(label, data){ const d=data?.daily||{}; const tmax=d.temperature_2m_max?.[0]; const tmin=d.temperature_2m_min?.[0]; const pop=d.precipitation_probability_max?.[0]; const tmax2=d.temperature_2m_max?.[1]; const tmin2=d.temperature_2m_min?.[1]; const pop2=d.precipitation_probability_max?.[1]; $q('#placeLabel').textContent=label||'â€”'; $q('#todayTemp').textContent=Number.isFinite(tmax)&&Number.isFinite(tmin) ? `${Math.round((tmax+tmin)/2)}â„ƒ` : '--â„ƒ'; $q('#todayRange').textContent=`ä»Šæ—¥: æœ€é«˜ ${tmax??'--'}â„ƒ / æœ€ä½ ${tmin??'--'}â„ƒ`; $q('#todayPop').textContent=`é™æ°´ç¢ºç‡ ${pop??'--'}%`; $q('#tomorrowRange').textContent=`æ˜æ—¥: æœ€é«˜ ${tmax2??'--'}â„ƒ / æœ€ä½ ${tmin2??'--'}â„ƒ`; $q('#tomorrowPop').textContent=`é™æ°´ç¢ºç‡ ${pop2??'--'}%`; $q('#updatedLabel').textContent='æ›´æ–°: '+fmtDate(new Date()); }
    async function updateWeatherFromSettings(){ const s=store.load(); let lat=s.lat, lon=s.lon, label=s.label; try{ if(!lat||!lon){ if(s.city){ const g=await geocodeCity(s.city); lat=g.lat; lon=g.lon; label=g.label; s.lat=lat; s.lon=lon; s.label=label; store.save(s); } else { throw new Error('no location'); } } const wx=await fetchWeather(lat, lon); localStorage.setItem('pwa.weather.cache', JSON.stringify({ when: Date.now(), label, wx })); renderWeather(label, wx); }catch(e){ const cache=JSON.parse(localStorage.getItem('pwa.weather.cache')||'null'); if(cache){ renderWeather(cache.label, cache.wx); } }
    }
    async function useGeolocation(){ try{ const pos=await new Promise((ok, ng)=>navigator.geolocation.getCurrentPosition(ok, ng, { enableHighAccuracy:true, timeout:8000 })); const lat=+pos.coords.latitude.toFixed(4); const lon=+pos.coords.longitude.toFixed(4); const s=store.load(); s.lat=lat; s.lon=lon; s.label=`ç¾åœ¨åœ° (${lat}, ${lon})`; delete s.city; store.save(s); updateWeatherFromSettings(); }catch(e){ alert('ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); } }

    // ========= é€šçŸ¥ï¼ˆç°¡æ˜“ï¼‰ =========
    async function requestNotification(){ if(!('Notification' in window)){ alert('ã“ã®ç«¯æœ«ã¯é€šçŸ¥ã«æœªå¯¾å¿œã§ã™'); return; } const perm=await Notification.requestPermission(); if(perm!=='granted'){ alert('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; } scheduleLocal6amReminder(); alert('é€šçŸ¥ã‚’è¨±å¯ã—ã¾ã—ãŸã€‚6:00ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆå‹•ä½œã¯ç«¯æœ«ä¾å­˜ï¼‰'); }
    function msUntilNext6am(){ const now=new Date(); const next=new Date(); next.setHours(6,0,0,0); if(next<=now) next.setDate(next.getDate()+1); return next-now; }
    function scheduleLocal6amReminder(){ const ms=msUntilNext6am(); setTimeout(()=>{ if(Notification.permission==='granted') new Notification('ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™', { body:'ä»Šæ—¥ã¨æ˜æ—¥ã®å¤©æ°—ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ï¼' }); scheduleLocal6amReminder(); }, ms); }

    // ========= PWAï¼ˆinstall + SWï¼‰ =========
    let deferredPrompt=null; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; document.getElementById('installBtn').style.display='inline-block'; });
    document.getElementById('installBtn').addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; document.getElementById('installBtn').style.display='none'; });
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./service-worker.js'); }); }

    // ========= ã‚¤ãƒ™ãƒ³ãƒˆæŸã­ =========
    document.getElementById('useGeo').addEventListener('click', useGeolocation);
    document.getElementById('openSettings').addEventListener('click', ()=> document.getElementById('settings').style.display='block');
    document.getElementById('closeSettings').addEventListener('click', ()=> document.getElementById('settings').style.display='none');
    document.getElementById('saveCity').addEventListener('click', async ()=>{ const city=document.getElementById('cityInput').value.trim(); const latlon=document.getElementById('latlonInput').value.trim(); const s=store.load(); if(latlon){ const m=latlon.split(',').map(x=>parseFloat(x.trim())); if(m.length===2 && m.every(Number.isFinite)){ s.lat=m[0]; s.lon=m[1]; s.label=`(${s.lat}, ${s.lon})`; delete s.city; } else { alert('ç·¯åº¦,çµŒåº¦ã®å½¢å¼ã«ã—ã¦ãã ã•ã„'); return; } } else if(city){ s.city=city; delete s.lat; delete s.lon; delete s.label; } else { alert('éƒ½å¸‚å ã‹ ç·¯åº¦çµŒåº¦ ã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; } store.save(s); document.getElementById('settings').style.display='none'; updateWeatherFromSettings(); });
    document.getElementById('notifyBtn').addEventListener('click', requestNotification);

    // ========= åˆæœŸåŒ– =========
    window.addEventListener('DOMContentLoaded', ()=>{ handleScroll(); cycleBackgrounds(); createCalendar(currentYear, currentMonth); });
    (async function initWeather(){ const s=store.load(); const first=!s.city && !s.lat && !s.lon; if(first && 'geolocation' in navigator){ try{ await useGeolocation(); }catch{} } updateWeatherFromSettings(); const cache=JSON.parse(localStorage.getItem('pwa.weather.cache')||'null'); if(cache){ renderWeather(cache.label, cache.wx); } })();
  </script>
</body>
</html>
